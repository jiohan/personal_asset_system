# 개인 자산 관리 PWA 해설서 (explain.md)

## 1. 이 문서의 목적
이 문서는 `PERSONAL_ASSET_PWA_GUIDE.md`를 처음 보는 사람도 프로젝트의 전체 구조를 이해할 수 있게 만든 해설서다.

이 문서를 읽고 얻어야 하는 핵심은 4가지다.
1. 우리가 어떤 문제를 해결하려는지
2. 어떤 기능을 어떤 순서로 만들려는지
3. 왜 도메인 규칙을 이렇게 엄격하게 정했는지
4. 개발 전에 문서를 구체화한 이유가 무엇인지

---

## 2. 우리가 만들 프로그램 한 줄 요약
이 프로젝트는 개인의 여러 계좌(입출금/저축/현금/투자)를 한 화면에서 관리하고, 거래 흐름을 왜곡 없이 보여주는 PC 중심 자산 관리 PWA다.

핵심 차별점은 단순하다.
- 내부 이체(내 계좌 -> 내 계좌)를 지출로 보지 않는다.
- 실제 소비 지출과 자금 이동을 분리해서 보여준다.

즉, 숫자가 "보기 좋은" 것이 아니라 "의미가 맞는" 서비스가 목표다.

---

## 3. 왜 이 프로그램을 만드는가
배경 문제는 명확하다.
- 기존 서비스에서 계좌 간 이동이 월 지출로 잡혀서 현금흐름이 왜곡됨
- 모바일 중심 UI는 전체 자산 흐름을 PC에서 한눈에 보기 어려움

프로젝트는 이 문제를 다음 방식으로 해결한다.
1. 거래 타입을 수입/지출/이체로 분리한다.
2. 리포트에서 이체를 현금흐름에서 제외한다.
3. 대신 이체는 별도 "자금이동" 리포트에서 보여준다.

이 원칙 하나가 제품 전체 설계의 중심축이다.

---

## 4. 제품의 핵심 기능과 연결 구조
기능은 개별로 존재하지 않고, 하나의 파이프라인으로 연결된다.

### 4.1 입력 단계
- 수동 입력
- CSV 업로드(1-shot import)

입력 단계의 목적은 "데이터를 넣는 것"이 아니라 "정확한 규칙으로 넣는 것"이다.

### 4.2 정리 단계
- 카테고리(2단계)
- 태그
- 인박스(`needsReview`) 처리

정리 단계의 목적은 나중 리포트 품질을 높이는 것이다.
분류가 불확실한 데이터는 즉시 리포트에 섞지 않고 인박스로 보낸다.

### 4.3 조회/분석 단계
- 거래 목록 필터/검색/정렬
- 월별 요약 리포트
- 카테고리 Top N
- 자금이동(TRANSFER) 리포트

분석 단계에서 가장 중요한 규칙은 다음이다.
- 총지출은 `EXPENSE`만 집계
- `TRANSFER`는 현금흐름에서 제외
- `excludeFromReports=true` 지출은 지출 통계에서 제외

### 4.4 보호 단계
- 소프트 삭제
- 백업/복원(v1)

데이터는 지우기보다 숨기고, 언제든 복구 가능한 형태를 유지한다.

---

## 5. 이 프로젝트의 도메인 모델 이해
개발자가 가장 먼저 맞춰야 할 것은 UI가 아니라 도메인 의미다.

### 5.1 Account(계좌)
역할
- 거래가 발생하는 주체

MVP 타입
- CHECKING, SAVINGS, CASH, INVESTMENT

핵심 원칙
- `currentBalance`는 저장하지 않고 계산한다.
- 이유: 거래 수정/삭제/재처리 시 저장된 잔액은 쉽게 깨진다.

### 5.2 Transaction(거래)
역할
- 돈의 변화 이벤트

타입
- INCOME: 외부 유입
- EXPENSE: 외부 유출
- TRANSFER: 내 계좌 간 이동

핵심 원칙
- `amount`는 항상 양수
- 부호는 타입/맥락으로 해석
- TRANSFER는 `fromAccountId`와 `toAccountId`를 반드시 가진다.

### 5.3 Category / Tag
Category
- MVP는 2단계(루트 + 자식)
- TRANSFER에도 카테고리 지정 가능
- 단, TRANSFER 카테고리는 지출 통계에 포함되지 않음

Tag
- API는 문자열 배열
- DB는 `transaction_tags` 조인 테이블
- 태그는 MVP에서 보조 검색 수단

### 5.4 Report
리포트는 단순 집계가 아니라 제품 정의 그 자체다.
- totalIncome
- totalExpense
- netSaving
- transferVolume
- inboxCount

이 지표의 포함/제외 규칙이 바뀌면 제품이 바뀌는 것이다.

---

## 6. 비즈니스 규칙을 강하게 고정한 이유
이 문서가 길어진 가장 큰 이유는 "정의의 모호함"을 제거하기 위해서다.

대표적으로 초기에 많이 깨지는 부분들:
1. 금액 부호를 DB에 섞어 저장함
2. 이체를 지출로 집계함
3. 카테고리 없는 거래를 그냥 리포트에 포함함
4. CSV import에서 부분 성공을 허용해 데이터 일관성이 깨짐
5. soft delete를 화면마다 다르게 처리함

그래서 이 프로젝트는 도메인 규칙을 문장 수준이 아니라 계약 수준으로 고정했다.
- API 계약
- DB 제약(CHECK/FK/인덱스)
- 리포트 정의서
- import 규칙

결론적으로 개발 속도를 늦추는 문서가 아니라, 재작업 비용을 줄이는 문서다.

---

## 7. API 계약이 왜 중요한가
프론트와 백엔드가 동시에 개발될 때 가장 많이 깨지는 지점은 API 해석 차이다.

이 프로젝트는 다음을 미리 고정했다.
- URL/메서드
- 요청/응답 구조
- 페이지네이션 규칙
- 날짜 범위 규칙(`from <= txDate < to`)
- 에러 코드(401/404/409/422)

이렇게 하면 프론트는 "무엇을 받을지"를 믿고 화면을 만들고,
백엔드는 "무엇을 지킬지"가 분명해져서 구현이 빨라진다.

---

## 8. DB 제약을 문서에 넣은 이유
"앱에서 검증하면 되지 않나"라고 생각하기 쉽다.
하지만 CSV, 배치, 버그, 동시성 상황에서는 앱 검증만으로 데이터 오염을 막기 어렵다.

그래서 DB 레벨에서 최소한을 강제한다.
- amount > 0
- 타입별 필드 상호배타
- excludeFromReports 의미 제한
- FK 무결성
- soft delete 중심 인덱스

핵심 철학:
- 잘못된 데이터가 들어간 뒤에 고치는 것보다, 들어오지 못하게 막는 것이 싸다.

---

## 9. 리포트 정의서를 분리한 이유
자산 서비스에서 가장 중요한 결과물은 "숫자"다.
숫자의 기준이 흔들리면 신뢰가 무너진다.

그래서 리포트 섹션을 별도 정의서처럼 고정했다.
- 카드별 정의(수식)
- 포함 조건
- 제외 조건
- 예외 규칙

특히 이 프로젝트의 핵심 규칙:
- TRANSFER는 현금흐름 제외
- TRANSFER는 자금이동 리포트에서만 집계

이 원칙은 사용자의 실제 불편(내부이체가 지출로 보이던 문제)을 직접 해결한다.

---

## 10. CSV Import를 단순화한 이유
CSV는 MVP에서 가장 자주 터지는 영역이다.

이번 프로젝트는 의도적으로 복잡도를 줄였다.
- preview/commit 2단계 대신 1-shot 고정
- 에러가 1건이라도 있으면 전체 롤백
- 중복은 skip, merge는 금지
- category 없으면 needsReview=true 자동 보정

이 정책의 장점:
1. 구현이 단순해진다.
2. 데이터 정합성이 좋아진다.
3. 사용자에게도 결과 설명이 명확해진다.

---

## 11. 인증/멀티유저 설계를 MVP에서 먼저 박은 이유
나중에 계정을 붙이면 스키마/API/쿼리가 거의 전부 바뀐다.
그래서 초기에 아래를 고정했다.
- `user_id` 기반 소유 모델
- 세션 쿠키 인증
- same-origin 운영
- CSRF 대응 방식
- 권한 실패 시 정책(404 노출 최소화)

이 결정을 미루면,
- 프론트 요청 방식
- 백엔드 보안 설정
- DB 인덱스 전략
이 반복적으로 바뀌어 개발 속도가 크게 떨어진다.

---

## 12. 백업/복원(v1)을 초기에 넣은 이유
개인 금융 데이터는 "잃어버리면 끝"에 가깝다.

그래서 MVP부터 최소 백업 체계를 포함한다.
- version 포함
- exportedAt 포함
- 원자적 복원
- 참조 무결성 검증

이 구조는 지금은 단순해 보여도,
향후 스키마 변경 때 마이그레이션 기준점이 된다.

---

## 13. 실제 개발 진행 방식: Vertical Slice
이 프로젝트는 레이어 분리 개발보다 "기능 단위 완결" 방식을 선택했다.

예시
- 로그인 기능 1개를 만들 때
  - DB, API, UI, 테스트까지 한 번에 완료

왜 이 방식인가
1. 실제 동작을 빨리 검증할 수 있다.
2. 도메인 규칙이 UI에서 어떻게 보이는지 즉시 확인 가능하다.
3. 나중에 통합하다 깨지는 비용을 줄인다.

MVP 권장 순서
1. Auth + user scope
2. Accounts CRUD
3. Transactions(INCOME/EXPENSE)
4. Transfer
5. Reports
6. CSV Import
7. Backup

---

## 14. 이 문서를 여기까지 구체화한 진짜 이유
이 프로젝트의 문서화는 "보기 좋게 정리"가 목적이 아니다.

진짜 목적은 아래 3가지다.
1. 의사결정 기록: 왜 이렇게 만들었는지 남긴다.
2. 충돌 방지: 프론트/백/DB가 같은 규칙을 본다.
3. 품질 기준 고정: 숫자와 규칙의 신뢰를 지킨다.

즉, 구현 전에 문서가 구체적일수록 개발 중 논쟁과 재작업이 줄어든다.

---

## 15. 주니어 개발자가 이 프로젝트에서 배우기 좋은 포인트
1. 도메인 모델링의 중요성
- 타입 하나(INCOME/EXPENSE/TRANSFER)를 정확히 정의하면 제품 품질이 달라진다.

2. API 계약 우선 설계
- 코드를 먼저 짜는 것보다 계약을 먼저 고정하면 협업이 빨라진다.

3. DB 제약의 실무 가치
- 앱 검증만으로는 부족하고, DB가 마지막 안전망이 되어야 한다.

4. 리포트는 제품 정의
- 집계 로직은 UI 장식이 아니라 핵심 비즈니스다.

5. 범위 통제(MVP)
- "할 수 있는 것"보다 "지금 해야 하는 것"을 고르는 능력이 중요하다.

---

## 16. 개발 착수 전 최종 체크리스트
아래가 YES이면 바로 구현에 들어가도 된다.

1. 거래 타입/부호/이체 규칙이 팀 내에서 동일하게 이해되었는가
2. API 계약(요청/응답/에러코드)이 확정되었는가
3. DB 제약(CHECK/FK/인덱스) 방향이 확정되었는가
4. 리포트 정의서(포함/제외)가 확정되었는가
5. CSV import 정책(1-shot, rollback, dedupe)이 확정되었는가
6. 인증/권한/user scope 정책이 확정되었는가
7. Vertical Slice 순서와 DoD가 합의되었는가

---

## 17. 한 문장 결론
이 프로젝트는 "가계부를 만드는 것"이 아니라,
"돈의 흐름을 왜곡 없이 해석하는 시스템"을 만드는 프로젝트다.

그리고 `PERSONAL_ASSET_PWA_GUIDE.md`를 구체화한 이유는
바로 그 왜곡 방지 원칙을 개발 전 단계에서 확정하기 위해서다.
